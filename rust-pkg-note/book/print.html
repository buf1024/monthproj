<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>rustlib-note</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">ç®€ä»‹</a></li><li class="chapter-item expanded affix "><li class="part-title">æ–‡æœ¬å¤„ç†</li><li class="chapter-item expanded "><a href="nom.html"><strong aria-hidden="true">1.</strong> nom -- ä¹é«˜å¼çš„è§£æå™¨ ğŸ‘</a></li><li class="chapter-item expanded affix "><li class="part-title">å…¶ä»–</li><li class="chapter-item expanded "><a href="lazy_static.html"><strong aria-hidden="true">2.</strong> lazy_static -- å…¨å±€é™æ€å˜é‡åˆåŒ–</a></li><li class="chapter-item expanded "><a href="config-rs.html"><strong aria-hidden="true">3.</strong> config-rs -- è¯»å–é…ç½®æ–‡ä»¶</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">rustlib-note</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="rust-library"><a class="header" href="#rust-library">Rust Library</a></h2>
<p>è¿™é‡Œè®°å½•ä¸€äº›Rustæ‰€ä½¿ç”¨çš„åŒ…ã€‚åªåšæœ€ç®€å•çš„ä½¿ç”¨è¯´æ˜ï¼Œä¸æ·±å…¥ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œè¿™äº›åŒ…å¯èƒ½åœæ­¢ç»´æŠ¤ä¸å†ä½¿ç”¨ï¼Œæˆ–è€…ä½¿ç”¨æ–¹æ³•å®Œå…¨ä¸å¯¹ï¼Œä¸€åˆ‡ä»¥å®˜æ–¹ä¸ºå‡†ã€‚è¿™é‡Œï¼Œè®°å½•ä¸‹æ¥è®©è‡ªå·±å‚è€ƒè€Œå·²ï¼Œè¯·å‹¿å¯¹å·å…¥åº§ã€‚ä½¿ç”¨<a href="https://github.com/rust-lang/mdBook">mdbook</a>è¿›è¡Œæµè§ˆå™¨æµè§ˆã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="ç®€ä»‹"><a class="header" href="#ç®€ä»‹">ç®€ä»‹</a></h2>
<p>å†™è¿‡parserçš„äººï¼Œä¸ç®¡æ˜¯ç®€å•çš„è‡ªå®šä¹‰åè®®ï¼Œæˆ–è€…å¤æ‚çš„åè®®ï¼Œä¸€èˆ¬éƒ½æ˜¯é‡‡ç”¨è‡ªä¸Šå¾€ä¸‹çš„è§£é‡Šæ–¹å¼ï¼Œä»ç¬¬1ä¸ªå­—èŠ‚ï¼Œä¸€è·¯å¼€é»‘ï¼Œåˆ°æœ€åå­—èŠ‚ã€‚é‡åˆ°<code>;</code>ç”¨ä¸€ä¸ªåˆ¤æ–­ï¼Œé‡åˆ°<code>:</code>ç”¨ä¸€ä¸ª<code>match</code>ç­‰ç­‰ï¼Œ<code>switch</code>ç›¸åº”çš„<code>case</code>ï¼Œæ‰€è°“é‡ç¥æ‹œç¥ï¼Œé‡é¬¼æ€é¬¼ï¼Œé‡ä½›å´ä¸çŸ¥æ‰€æªã€‚è¿™æ ·çš„é—®é¢˜æ˜¯ï¼ŒåŠ ä¸Šé”™è¯¯å¤„ç†ï¼Œ<code>if else</code>å¯èƒ½ä¼šè¿‡äºå¤æ‚è€Œå‡Œä¹±ï¼Œæ—¶é—´ä¹…äº†ï¼Œéš¾ä»¥ç»´æŠ¤ã€‚ç¨å¾®é«˜ç«¯ç‚¹çš„ï¼Œå¯èƒ½ä¼šå†™å‡ºå‡ ä¸ªå¤æ‚ä¸€ç‚¹çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œä¸è¿‡æœ€åä¹Ÿå¾ˆæœ‰å¯èƒ½ï¼Œæœ€ç»ˆå¿˜è®°å½“åˆå†™è¿™æ­£åˆ™çš„å«ä¹‰ã€‚é«˜ç«¯ç©å®¶ä¼°è®¡å°±ç”¨<code>lex/yacc flex/bison</code>ï¼Œçš„ç¡®å¥½ç”¨åˆå¥½ç»´æŠ¤ï¼Œé™¤äº†å¢åŠ ä¸€ä¸‹æè¿°æ–‡ä»¶ï¼Œå¢åŠ ä¸€äº›ä¸å¼€å‘è¯­è¨€æ— å…³çš„ä¸œè¥¿ã€‚ä¸è¿‡æ€é¸¡ç„‰ç”¨ç‰›åˆ€ï¼Œè¿™ä¹ˆåºå¤§çš„å·¥å…·ï¼Œæœ‰å¿…è¦å‰²æœ¬æ¥å°±å°çš„å°JJï¼Ÿï¼</p>
<p><a href="https://github.com/Geal/nom">nom</a>æä¾›ä¸€ç§æ¯”è¾ƒæ¸…å¥‡çš„æ€è·¯ï¼Œä¼°è®¡ä½œè€…æ·±å—ä¹é«˜çš„ç†é™¶ï¼Œæ‰æœ‰è¿™ç§åˆ›é€ ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œä¹é«˜ç©å…·ï¼Œæä¾›çš„æ˜¯å¾ˆé™çš„å‡ ä¸ªåŸºç¡€å½¢çŠ¶æ¨¡å—ï¼Œé€šè¿‡ä¸€ä¸ªä¸ªæ¨¡å—çš„ç»„åˆèµ·æ¥ï¼Œå°±å¯ä»¥å®ç°å„ç§ç‰©ä»¶çš„åˆ›ä½œï¼Œæ ©æ ©å¦‚ç”Ÿã€‚<a href="https://github.com/Geal/nom">nom</a>çš„æ€è·¯å¹¶ä¸æ˜¯æ•™ä½ å¦‚ä½•åƒ<code>lex/yacc</code>æ„é€ ç‰¹å®šè¯­æ³•çš„æ¨¡æ¿æ–‡ä»¶ï¼Œä¹Ÿä¸æœŸå¾…ä½ è‡ªé¡¶è€Œä¸‹è§£é‡Šï¼Œè€Œæ˜¯åƒä¹é«˜ä¸€æ ·ï¼Œæä¾›å¾ˆå¤šåŸºç¡€çš„åŸºç¡€å½¢çŠ¶ï¼Œå¦‚<code>tag, take_while1, is_a</code>ç­‰ï¼Œå¹¶æä¾›ç»„åˆä¸€èµ·çš„æ–¹æ³•ï¼Œå¦‚<code>alt, tupple, preceded</code>ç­‰ã€‚ç”¨å„ç§æ–¹æ³•å¯ä»¥ç»„åˆï¼Œå½¢æˆå„å¼å„æ ·çš„parserï¼Œè€Œåˆä¸æŸå¤±ä»»ä½•æ€§èƒ½ã€‚</p>
<p><a href="https://github.com/Geal/nom">nom</a>å‡½æ•°çš„è®¾è®¡é«˜åº¦ä¸€è‡´ï¼Œå‡ ä¹æ‰€æœ‰å‡½æ•°çš„è°ƒç”¨ï¼Œéƒ½è¿”å›å¸¦ç›¸åŒç­¾åçš„å‡½æ•°:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// ä¸€èˆ¬å‡½æ•°è¿”å›
impl Fn(Input) -&gt; IResult&lt;Input, Output, Error&gt;

// IResultå®šä¹‰
pub type IResult&lt;I, O, E = error::Error&lt;I&gt;&gt; = Result&lt;(I, O), Err&lt;E&gt;&gt;;

// ParseError&lt;I&gt; ä¸º () å®ç°äº†ï¼Œæ‰€ä»¥ä¸€èˆ¬å¯ä»¥ç”¨()ï¼Œæ–¹ä¾¿ä½¿ç”¨ParseError
impl&lt;I&gt; ParseError&lt;I&gt; for ()
<span class="boring">}
</span></code></pre></pre>
<p><a href="https://github.com/Geal/nom">nom</a>çš„åŸºç¡€å‡½æ•°æ„é€ å—ï¼Œåˆ†ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªæ˜¯<code>complete</code>å’Œ<code>stream</code>ç‰ˆæœ¬ï¼Œä¸¤ä¸ªç›´è§‚ä¸Šæœ€å¤§çš„åŒºåˆ«æ˜¯æŠ¥é”™æ–¹å¼ï¼Œ<code>stream</code>ç‰ˆæœ¬æŠ¥é”™ä¸º<code>Err::Incomplete(n)</code>ï¼Œ<code>complete</code>ç›´æ¥æŠ¥<code>Err::Error/Err::Failure</code>ã€‚é™¤æ­¤ä¹‹åï¼Œä½¿ç”¨ä¸Šå¹¶æ²¡æœ‰æ˜æ˜¾çš„å·®å¼‚ã€‚</p>
<p><a href="https://github.com/Geal/nom">nom</a>çš„parserå’Œcombinatoråº”æœ‰å°½æœ‰ï¼Œæ²¡æœ‰çš„ä¹Ÿå¯ä»¥ç»„åˆå‡ºæ¥ã€‚é™¤äº†<a href="https://docs.rs">docs.rs</a>çš„æ–‡æ¡£ï¼Œä½œè€…è¿˜è´´å¿ƒçš„åˆ—å‡ºæ¥(å› ä¸ºrustç”Ÿæˆçš„æ–‡æ¡£ä¸æ–¹ä¾¿ä¸€èµ·çœ‹)ï¼Œè¿™é‡Œä¸ç´¯èµ˜ï¼Œå‚è€ƒä½œè€…ä»‹ç»<a href="https://github.com/Geal/nom/blob/master/doc/choosing_a_combinator.md">choosing_a_combinator</a>ã€‚</p>
<h2 id="ç¤ºä¾‹"><a class="header" href="#ç¤ºä¾‹">ç¤ºä¾‹</a></h2>
<p><a href="https://tokio.rs">tokio</a>çš„å®˜æ–¹æ•™ç¨‹<a href="https://tokio.rs/tokio/tutorial">tutorial</a>æ˜¯å­¦ä¹ rustå¾ˆå¥½çš„ä¸€ä¸ªå¼€å§‹çš„åœ°æ–¹ï¼ŒæŠŠä¹‹å‰<code>C/C++</code>å·²æœ‰çš„æ¦‚å¿µç”¨rustå®ç°äº†ä¸€éï¼Œæ—¢äº²åˆ‡åˆç†Ÿæ‚‰ã€‚<a href="https://tokio.rs">tokio</a>çš„å®˜æ–¹æ•™ç¨‹<a href="https://tokio.rs/tokio/tutorial">tutorial</a>æ˜¯å®ç°ç®€å•redisåŠŸèƒ½ï¼Œä»£ç ä»“åº“ä½äº: <a href="https://github.com/tokio-rs/mini-redis">mini-redis</a>ã€‚ <a href="https://github.com/tokio-rs/mini-redis">mini-redis</a>å¯¹äºredisåè®®çš„è§£ææ˜¯é€šè¿‡ä¸€ä¸ªå­—èŠ‚è§£æçš„ï¼Œå¹¸å¥½ç®€å•ï¼Œæ‰€ä»¥åŸå®ç°å¹¶ä¸å‡Œä¹±ã€‚ç°ä¿®æ”¹ä¸ºç”¨<a href="https://github.com/Geal/nom">nom</a>è§£ææ–¹å¼ï¼Œä»£ç ä»“åº“ä½äº: <a href="https://github.com/buf1024/buf1024.github.io/tree/master/.demo/rust-lib/mini-redis">https://github.com/buf1024/buf1024.github.io/tree/master/.demo/rust-lib/mini-redis</a>ï¼Œåè®®è§£æçš„æ–‡ä»¶ï¼š<a href="https://github.com/buf1024/blog-demo/blob/master/rust-lib/mini-redis/src/frame.rs">frame.rs</a></p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// A frame in the Redis protocol.
/// åè®®æ ¼å¼
#[derive(Clone, Debug)]
pub enum Frame {
    // +xxx\r\n ç®€å•çš„string
    Simple(String),
    // -xxx\r\n é”™è¯¯çš„string
    Error(String),
    // :ddd\r\n u64æ•°å€¼
    Integer(u64),
    // $dd\r\nbbbbb\r\n æœ‰å†…å®¹çš„chunk
    Bulk(Bytes),
    // $-1\r\n ç©ºChunk
    Null,
    // *dd\r\nxxx\r\n array dd æˆ‘æ•°é‡
    Array(Vec&lt;Frame&gt;),
}
<span class="boring">}
</span></code></pre></pre>
<p>mini-redisç®€å•å®ç°äº†redisçš„5ä¸ªåŸºæœ¬åè®®ï¼Œå®ç°å¹¶ä¸å¤æ‚ï¼Œæ‹¼æ‹¼å‡‘å‡‘å°±æˆäº†ï¼Œé­”æ”¹çš„<a href="https://github.com/Geal/nom">nom</a>çš„ç‰ˆæœ¬å¦‚ä¸‹:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn parse_simple(src: &amp;str) -&gt; IResult&lt;&amp;str, (Frame, usize)&gt;
    {
        let (input, output) = delimited(tag(&quot;+&quot;), take_until1(&quot;\r\n&quot;), tag(&quot;\r\n&quot;))(src)?;
        Ok((input, (Frame::Simple(String::from(output)), src.len() - input.len())))
    }

    fn parse_error(src: &amp;str) -&gt; IResult&lt;&amp;str, (Frame, usize)&gt;
    {
        let (input, output) = delimited(tag(&quot;-&quot;), take_until1(&quot;\r\n&quot;), tag(&quot;\r\n&quot;))(src)?;
        Ok((input, (Frame::Error(String::from(output)), src.len() - input.len())))
    }

    fn parse_decimal(src: &amp;str) -&gt; IResult&lt;&amp;str, (Frame, usize)&gt;
    {
        let (input, output) = map_res(
            delimited(tag(&quot;:&quot;), take_until1(&quot;\r\n&quot;), tag(&quot;\r\n&quot;)),
            |s: &amp;str| u64::from_str_radix(s, 10),
        )(src)?;
        Ok((input, (Frame::Integer(output), src.len() - input.len())))
    }

    fn parse_bulk(src: &amp;str) -&gt; IResult&lt;&amp;str, (Frame, usize)&gt;
    {
        let (input, output) = alt((
            map(tag(&quot;$-1\r\n&quot;), |_| Frame::Null),
            map(terminated(length_value(
                map_res(
                    delimited(tag(&quot;$&quot;), take_until1(&quot;\r\n&quot;), tag(&quot;\r\n&quot;)),
                    |s: &amp;str| u64::from_str_radix(s, 10)),
                rest),
                           tag(&quot;\r\n&quot;),
            ), |out| {
                let data = Bytes::copy_from_slice(out.as_bytes());
                Frame::Bulk(data)
            }))
        )(src)?;
        Ok((input, (output, src.len() - input.len())))
    }

    fn parse_array(src: &amp;str) -&gt; IResult&lt;&amp;str, (Frame, usize)&gt;
    {
        let (input, output) =
            map(length_count(
                map_res(
                    delimited(tag(&quot;*&quot;), take_until1(&quot;\r\n&quot;), tag(&quot;\r\n&quot;)),
                    |s: &amp;str| {
                        println!(&quot;{}&quot;, s);
                        u64::from_str_radix(s, 10)
                    }),
                Frame::parse,
            ), |out| {
                let data = out.iter().map(|item| item.0.clone()).collect();
                Frame::Array(data)
            },
            )(src)?;
        Ok((input, (output, src.len() - input.len())))
    }

    pub fn parse(src: &amp;str) -&gt; IResult&lt;&amp;str, (Frame, usize)&gt;
    {
        alt((Frame::parse_simple, Frame::parse_error, Frame::parse_decimal, Frame::parse_bulk, Frame::parse_array))(src)
    }
<span class="boring">}
</span></code></pre></pre>
<p>å¯ä»¥çœ‹åˆ°<a href="https://github.com/Geal/nom">nom</a>çš„ç‰ˆæœ¬æœ‰å¾ˆç®€æ´çš„æ–¹å¼ï¼Œç”šè‡³ä¸€è¡Œä»£ç å³å¯å®ç°ï¼Œä¸éœ€è¦åŸä»£ç é‚£æ ·ï¼Œä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚çš„åˆ¤æ–­ï¼Œæ¥æ“æ§å’Œç§»åŠ¨å†…å­˜ä½ç½®ã€‚å°±ç±»ä¼¼ä¹é«˜ç§¯æœ¨ä¸€æ ·ï¼Œä¸€ä¸ªä¸€ä¸ªçš„å èµ·æ¥ï¼Œç®€å•åˆç®€æ´ã€‚</p>
<p>æµ‹è¯•ï¼š</p>
<pre><code class="language-shell">^_^@~/rust-lib/mini-redis]$ RUST_LOG=debug cargo run --bin mini-redis-server
   Compiling mini-redis v0.4.0 (~/rust-lib/mini-redis)
    Finished dev [unoptimized + debuginfo] target(s) in 7.44s
     Running `target/debug/mini-redis-server`
Sep 13 00:10:16.517  INFO mini_redis::server: accepting inbound connections
Sep 13 00:10:40.261 DEBUG mini_redis::server: accept address from 127.0.0.1:55931
5
Sep 13 00:10:40.264 DEBUG run: mini_redis::connection: nom frame: Array([Bulk(b&quot;set&quot;), Bulk(b&quot;hello&quot;), Bulk(b&quot;world&quot;), Bulk(b&quot;px&quot;), Integer(3600)]), n: 50
Sep 13 00:10:40.264 DEBUG run: mini_redis::server: cmd=Set(Set { key: &quot;hello&quot;, value: b&quot;world&quot;, expire: Some(3.6s) })
Sep 13 00:10:40.264 DEBUG run:apply: mini_redis::cmd::set: response=Simple(&quot;OK&quot;)
^CSep 13 00:10:52.278 DEBUG my_exit: mini_redis_server: press once more to exit
^CSep 13 00:10:52.934 DEBUG my_exit: mini_redis_server: now exit
Sep 13 00:10:52.934  INFO mini_redis::server: shutting down

^_^@~/rust-lib/mini-redis]$ RUST_LOG=debug cargo run --bin mini-redis-cli set hello world 3600 
   Compiling mini-redis v0.4.0 (~/rust-lib/mini-redis)
    Finished dev [unoptimized + debuginfo] target(s) in 1.61s
     Running `target/debug/mini-redis-cli set hello world 3600`
Sep 13 00:10:40.262 DEBUG set_expires{key=&quot;hello&quot; value=b&quot;world&quot; expiration=3.6s}: mini_redis::client: request=Array([Bulk(b&quot;set&quot;), Bulk(b&quot;hello&quot;), Bulk(b&quot;world&quot;), Bulk(b&quot;px&quot;), Integer(3600)])
Sep 13 00:10:40.265 DEBUG set_expires{key=&quot;hello&quot; value=b&quot;world&quot; expiration=3.6s}: mini_redis::connection: nom frame: Simple(&quot;OK&quot;), n: 5
Sep 13 00:10:40.265 DEBUG set_expires{key=&quot;hello&quot; value=b&quot;world&quot; expiration=3.6s}: mini_redis::client: response=Some(Simple(&quot;OK&quot;))
OK

</code></pre>
<h2 id="å°ç»“"><a class="header" href="#å°ç»“">å°ç»“</a></h2>
<p>rustçš„<a href="https://github.com/Geal/nom">nom</a>æä¾›ä¸€ç§ç±»ä¼¼äºä¹é«˜ç§¯æœ¨çš„æ–¹å¼å»æ„é€ è§£æå™¨ï¼Œé€šè¿‡ç»„åˆå„ç§åŸºæœ¬çš„parserï¼Œå®Œå…¨å¯ä»¥æ„é€ å‡ºè¶³å¤Ÿå¤æ‚çš„è§£æå™¨ï¼ŒåŒæ—¶ä¸ä¼šå› ä¸ºç»„åˆå„ç§parserï¼Œè€Œå¤±å»ä»»ä½•æ€§èƒ½ã€‚åŒæ—¶ï¼Œå¾—ç›Šäºå…¶å‘½åæ–¹å¼å’Œç»Ÿä¸€çš„å‡½æ•°è¿”å›å½¢å¼ï¼ŒåŸºäº<a href="https://github.com/Geal/nom">nom</a>çš„è§£æå™¨ï¼Œè¯­ä¹‰ä¸Šæ¯”é‚£äº›<code>get_line</code>ä¹‹ç±»çš„ï¼Œæ¸…æ™°å¤ªå¤šã€‚æ‰€ä»¥åœ¨è§£æä»»åŠ¡ä¸Šï¼Œé™¤äº†æœ‰ç°æˆè€Œåˆæˆç†Ÿçš„è§£æåº“ï¼Œå®Œå…¨å¯ä»¥è€ƒè™‘é‡‡ç”¨çš„ï¼Œè€Œé<code>get_lineï¼Œget_u8</code>é‚£æ ·ä¸€ä¸ªå­—èŠ‚çš„æˆ–è€…æ­£åˆ™é‚£æ ·ä¸€ä¸ªæ¨¡å¼çš„ï¼Œå¼€é»‘ä¸‹å»â€¦â€¦</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="ç®€ä»‹-1"><a class="header" href="#ç®€ä»‹-1">ç®€ä»‹</a></h2>
<p>å…¨å±€é™æ€å˜é‡åˆåŒ–ï¼Œåœ¨ä»–ç¼–ç¨‹è¯­è¨€é‡Œé¢ï¼Œæ˜¯ä¸€ä¸ªå¾ˆç®€å•åˆè‡ªç„¶çš„äº‹ï¼Œç„¶è€Œåœ¨rusté‡Œé¢å¹¶éå®¹æ˜“ã€‚å¦‚æœåƒä¸‹é¢å®šä¹‰å…¨å±€é™æ€å˜é‡ï¼Œé‚£ä¹ˆä¼šæŠ¥é”™ï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>static ref VEC_VAL: Vec&lt;String&gt; = vec![&quot;1, 2, 3&quot;.into()];
<span class="boring">}
</span></code></pre></pre>
<p>é™æ€å˜é‡ä¸å…è®¸åŠ¨æ€åˆ†é…å†…å­˜:</p>
<pre><code class="language-shell">error[E0010]: allocations are not allowed in statics
 --&gt; bin/lazy_static.rs:5:29
  |
5 | static VEC_VAL: Vec&lt;String&gt; = vec![&quot;1, 2, 3&quot;.into()];
  |                             ^^^^^^^^^^^^^^^ allocation not allowed in statics
  |
  = note: this error originates in a macro (in Nightly builds, run with -Z macro-backtrace for more info)
</code></pre>
<p><a href="https://docs.rs/lazy_static/1.4.0/lazy_static/">lazy_static</a>æä¾›ä¸€ç§åˆå§‹åŒ–é™æ€å…¨å±€å˜é‡çš„æ–¹å¼ï¼Œé€šè¿‡<a href="https://docs.rs/lazy_static/1.4.0/lazy_static/">lazy_static</a>å®ï¼Œå…¨å±€é™æ€å˜é‡è¢«å»¶è¿Ÿåˆ°ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶æ‰åˆå§‹åŒ–ï¼Œå¹¶åªåˆå§‹åŒ–ä¸€æ¬¡ã€‚<a href="https://docs.rs/lazy_static/1.4.0/lazy_static/">lazy_static</a>å®ï¼ŒåŒ¹é…çš„æ˜¯<code>static ref</code>ï¼Œæ‰€ä»¥å®šä¹‰çš„é™æ€å˜é‡éƒ½æ˜¯ä¸å¯å˜å¼•ç”¨ã€‚å¦‚:</p>
<pre><pre class="playground"><code class="language-rust">use std::collections::HashMap;

#[macro_use]
extern crate lazy_static;

lazy_static! {
    static ref INT_VAL: i32 = 10;
    static ref VEC_VAL: Vec&lt;String&gt; = vec![&quot;1, 2, 3&quot;.into()];

    static ref MAP_VAL: HashMap&lt;String, String&gt; = {
        let mut map = HashMap::new();
        map.insert(&quot;Hello&quot;.into(), &quot;world&quot;.into());
        map.insert(&quot;F*k&quot;.into(), &quot;me&quot;.into());
        map
    };
}
fn main() {
    println!(&quot;{}, {:?}&quot;, *INT_VAL, *VEC_VAL);
    MAP_VAL.iter().for_each(|(k, v)| {
        println!(&quot;key={}, value={}&quot;, k, v);
    })
}
</code></pre></pre>
<p>è¾“å‡º:</p>
<pre><code class="language-shell">10, [&quot;1, 2, 3&quot;]
key=Hello, value=world
key=F*k, value=me
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="ç®€ä»‹-2"><a class="header" href="#ç®€ä»‹-2">ç®€ä»‹</a></h2>
<p>è¯»å–é…ç½®æ–‡ä»¶æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„éœ€æ±‚ï¼Œä¸è¿‡ä¸åŒçš„äººå¯èƒ½ä¼šé€‰æ‹©ä¸åŒçš„é…ç½®æ–‡ä»¶æ ¼å¼ï¼Œæœ‰çš„äººé€‰æ‹©tomlï¼Œæœ‰çš„äººé€‰æ‹©iniï¼Œåˆæˆ–è€…æ˜¯ä»ç¯å¢ƒå˜é‡é’Ÿè·å–ã€‚æ‰€ä»¥ï¼Œå¯¹åº”è¯»å–ç‰¹å®šçš„æ–‡ä»¶æ ¼å¼ï¼Œåº”ç”¨ç¨‹åºä¸€èˆ¬ç”¨é€‰ç”¨ç‰¹å®šæ–‡ä»¶æ ¼å¼çš„åº“ã€‚<a href="https://github.com/mehcode/config-rs">config-rs</a>æä¾›ä¸€ç§æ¯”è¾ƒå…¨é¢(æ”¯æŒä¸»æµçš„å„ç§æ–‡ä»¶æ ¼å¼)è€Œä½¿ç”¨ç®€å•çš„æ–¹å¼ã€‚</p>
<h2 id="ç¤ºä¾‹-1"><a class="header" href="#ç¤ºä¾‹-1">ç¤ºä¾‹</a></h2>
<p>å‡è®¾æœ‰ä»¥ä¸‹é…ç½®æ–‡ä»¶ï¼š</p>
<pre><code class="language-toml"># æ–‡ä»¶
#examples/config/default.toml
#examples/config/dev.toml
#examples/config/pro.toml
#åˆ†åˆ«å¯¹åº”defaulté…ç½®ï¼Œå¼€å‘å’Œç”Ÿäº§é…ç½®
# é…ç½®å†…å®¹éƒ½æ˜¯ä»¥ä¸‹ï¼Œé”®ä¸€æ ·ï¼Œå€¼ä¸ä¸€æ ·ï¼Œç”šè‡³defaultç¼ºå¤±ä¸€äº›å€¼
[database]
url = &quot;postgres://postgres@localhost-def-ini&quot;

[secret]
key = &quot;def-key-ini&quot;
token = &quot;def-token-ini&quot;
</code></pre>
<pre><pre class="playground"><code class="language-rust">use config::{Config, Environment, File};
use std::env;
use serde_derive::Deserialize;

#[derive(Debug, Deserialize)]
#[allow(unused)]
struct Database {
    url: String,
}

#[derive(Debug, Deserialize)]
#[allow(unused)]
struct Secret {
    key: String,
    token: String,
    version: u8,
}

#[derive(Debug, Deserialize)]
#[allow(unused)]
struct Settings {
    debug: bool,
    database: Database,
    secret: Secret,
}


fn main() {
    let run_mode = env::var(&quot;RUN_MODE&quot;).unwrap_or(&quot;dev&quot;.into());

  	// add_sourceåé¢çš„ï¼Œä¼šè¦†ç›–å‰é¢çš„
    let s = Config::builder()
  			// é»˜è®¤é…ç½®
        .add_source(File::with_name(&quot;examples/config/default&quot;))
  			// pro/dev é…ç½®ä¼šè¦†ç›–é»˜è®¤é…ç½®
        .add_source(File::with_name(&amp;format!(&quot;example/config/{}&quot;, run_mode)).required(false))
  			// æ³¨æ„ç¯å¢ƒå˜é‡ä¸€APP_å¼€å¤´çš„ï¼Œå¦‚æœAPP_DEBUGï¼Œå¤§å°å†™æ— å…³
        .add_source(Environment::with_prefix(&quot;APP&quot;))
        .build()
        .unwrap();

    println!(&quot;debug: {:?}&quot;, s.get_bool(&quot;debug&quot;));
    println!(&quot;database: {:?}&quot;, s.get::&lt;String&gt;(&quot;database.url&quot;));
    let settings: Settings = s.try_deserialize().unwrap();

    println!(&quot;settings: {:?}&quot;, settings);
}

</code></pre></pre>
<p>è¾“å‡º:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>$ APP_debug=0 cargo run --color=always --package rust-me --example config
debug: Ok(false)
database: Ok(&quot;postgres://postgres@localhost-def-ini&quot;)
settings: Settings { debug: false, database: Database { url: &quot;postgres://postgres@localhost-def-ini&quot; }, secret: Secret { key: &quot;def-key-ini&quot;, token: &quot;def-token-ini&quot;, version: 120 } }

<span class="boring">}
</span></code></pre></pre>
<p>å¯è§ï¼Œä½¿ç”¨å¤ªç®€å•äº†ã€‚</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
